---
import { getLangFromUrl, locales, useTranslation, slugify } from ".";
const currentLang = getLangFromUrl(Astro.url);

// Build a map of route slugs per language based on translation labels
const SLUGS: Record<string, Record<string, string>> = {};
const routeKeys = new Set<string>();
for (const [l] of Object.entries(locales)) {
  const t = await useTranslation(l as any);
  SLUGS[l] = {} as Record<string, string>;
  Object.entries(t.AREAS || {}).forEach(([key, label]) => {
    if (key === "SMART_ECOSYSTEM_ITEMS") {
      // We don't add SMART_ECOSYSTEM_ITEMS to routeKeys, but its items.
      (label as any[]).forEach((item, index) => {
        const itemKey = `SMART_ECOSYSTEM_ITEM_${index}`;
        SLUGS[l][itemKey] = slugify(item.TITLE_TEXT);
        routeKeys.add(itemKey);
      });
    } else {
      routeKeys.add(key);
      if (key === "SMART_ECOSYSTEM") {
        SLUGS[l][key] = "";
      } else {
        SLUGS[l][key] = slugify(String(label));
      }
    }
  });
}
const ROUTE_KEYS = Array.from(routeKeys);
---

<select name="language" id="i18n-language-picker" class="font-semibold text-xs md:text-base">
  {
    Object.entries(locales).map(([lang, label]) => (
      <option class="text-black text-sm md:text-base" value={lang}>{label}</option>
    ))
  }
</select>

<script define:vars={{ currentLang, SLUGS, ROUTE_KEYS }}>
  // Normaliza el `currentLang` (quita barras) para evitar "\/en" vs "en" mismatches
  const CURRENT_LANG = String(currentLang || "").replace(/^\/+|\/+$/g, "");
  const i18nPicker = document.querySelector("#i18n-language-picker");
  const path = window.location.pathname;

  if (i18nPicker) i18nPicker.value = CURRENT_LANG;

  function detectRouteKey() {
    const parts = path.split("/").filter(Boolean); // ['lang', 'slug', ...]
    // Si la ruta no tiene prefijo de idioma, asumimos `CURRENT_LANG` como idioma actual
    const langInPath = parts[0] || CURRENT_LANG;
    const slug = parts[1] || ""; // cuando existe prefijo de idioma, parts[1] es el slug

    for (const key of ROUTE_KEYS) {
      if (key === "home" && (slug === "" || slug === undefined)) return "home";
      if (SLUGS[langInPath] && SLUGS[langInPath][key] === slug) return key;
    }
    return null;
  }

  if (i18nPicker) {
    i18nPicker.onchange = (e) => {
      const selectedLang = e.target.value;
      const routeKey = detectRouteKey();
      let newPath = `/${selectedLang}/`;
      if (routeKey && routeKey !== "home") {
        const newSlug = SLUGS[selectedLang] && SLUGS[selectedLang][routeKey];
        if (newSlug) newPath = `/${selectedLang}/${newSlug}/`;
      }
      if (window.location.pathname !== newPath) {
        window.location.pathname = newPath;
      }
    };
  }
</script>
